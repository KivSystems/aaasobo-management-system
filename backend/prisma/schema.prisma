// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

model Instructor {
  id                              Int                               @id @default(autoincrement())
  name                            String
  email                           String                            @unique
  password                        String
  instructorAvailability          InstructorAvailability[]
  classes                         Class[]
  instructorRecurringAvailability InstructorRecurringAvailability[]
  recurringClasses                RecurringClass[]
  classURL                        String                            @unique
  icon                            String                            @unique
  nickname                        String                            @unique
  birthdate                       DateTime
  lifeHistory                     String
  favoriteFood                    String
  hobby                           String
  messageForChildren              String
  workingTime                     String
  skill                           String
  meetingId                       String                            @unique
  passcode                        String                            @unique
  instructorUnavailability        InstructorUnavailability[]
  introductionURL                 String                            @unique
  createdAt                       DateTime                          @default(now())
  inactiveAt                      DateTime?
  instructorSchedules             InstructorSchedule[]
  instructorAbsences              InstructorAbsence[]
}

model InstructorRecurringAvailability {
  id                     Int                      @id @default(autoincrement())
  instructorId           Int
  startAt                DateTime
  endAt                  DateTime?
  instructor             Instructor               @relation(fields: [instructorId], references: [id])
  instructorAvailability InstructorAvailability[]
}

model InstructorAvailability {
  instructorId                      Int
  instructorRecurringAvailabilityId Int
  dateTime                          DateTime
  instructor                        Instructor                       @relation(fields: [instructorId], references: [id])
  instructorRecurringAvailability   InstructorRecurringAvailability? @relation(fields: [instructorRecurringAvailabilityId], references: [id])

  @@id([instructorId, dateTime])
}

model InstructorUnavailability {
  instructorId Int
  dateTime     DateTime
  instructor   Instructor @relation(fields: [instructorId], references: [id])

  @@id([instructorId, dateTime])
}

model Customer {
  id             Int            @id @default(autoincrement())
  name           String
  email          String         @unique
  emailVerified  DateTime?
  password       String
  classes        Class[]
  children       Children[]
  subscription   Subscription[]
  prefecture     String
  hasSeenWelcome Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model Class {
  id               Int               @id @default(autoincrement())
  instructorId     Int?
  customerId       Int
  recurringClassId Int?
  dateTime         DateTime?
  status           Status
  instructor       Instructor?       @relation(fields: [instructorId], references: [id])
  customer         Customer          @relation(fields: [customerId], references: [id])
  recurringClass   RecurringClass?   @relation(fields: [recurringClassId], references: [id])
  classAttendance  ClassAttendance[]
  subscriptionId   Int?
  subscription     Subscription?     @relation(fields: [subscriptionId], references: [id])
  rebookableUntil  DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  classCode        String
  isFreeTrial      Boolean           @default(false)
}

enum Status {
  booked
  completed
  canceledByCustomer
  canceledByInstructor
  pending
  rebooked
  declined
}

model Admins {
  id       Int    @id @default(autoincrement())
  name     String
  email    String @unique
  password String
}

model Children {
  id                       Int                        @id @default(autoincrement())
  customerId               Int
  name                     String
  customer                 Customer                   @relation(fields: [customerId], references: [id])
  classAttendance          ClassAttendance[]
  recurringClassAttendance RecurringClassAttendance[]
  birthdate                DateTime?
  personalInfo             String?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @default(now()) @updatedAt
}

model ClassAttendance {
  classId    Int
  childrenId Int
  class      Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  children   Children @relation(fields: [childrenId], references: [id])

  @@id([classId, childrenId])
}

model Plan {
  id               Int            @id @default(autoincrement())
  name             String         @unique
  weeklyClassTimes Int
  description      String
  subscription     Subscription[]
}

model Subscription {
  id             Int              @id @default(autoincrement())
  planId         Int
  customerId     Int
  startAt        DateTime
  endAt          DateTime?
  plan           Plan             @relation(fields: [planId], references: [id])
  customer       Customer         @relation(fields: [customerId], references: [id])
  class          Class[]
  recurringClass RecurringClass[]
}

model RecurringClass {
  id                       Int                        @id @default(autoincrement())
  instructorId             Int?
  subscriptionId           Int?
  startAt                  DateTime?
  endAt                    DateTime?
  instructor               Instructor?                @relation(fields: [instructorId], references: [id])
  subscription             Subscription?              @relation(fields: [subscriptionId], references: [id])
  recurringClassAttendance RecurringClassAttendance[]
  classes                  Class[]
}

model RecurringClassAttendance {
  recurringClassId Int
  childrenId       Int
  recurringClass   RecurringClass @relation(fields: [recurringClassId], references: [id])
  children         Children       @relation(fields: [childrenId], references: [id])

  @@id([recurringClassId, childrenId])
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model Schedule {
  id      Int      @id @default(autoincrement())
  date    DateTime @unique
  eventId Int
  event   Event    @relation(fields: [eventId], references: [id])
}

model Event {
  id       Int        @id @default(autoincrement())
  name     String     @unique
  color    String     @unique
  Schedule Schedule[]
}

model InstructorSchedule {
  id            Int              @id @default(autoincrement())
  instructorId  Int
  effectiveFrom DateTime         @db.Date
  effectiveTo   DateTime?        @db.Date
  timezone      String
  instructor    Instructor       @relation(fields: [instructorId], references: [id])
  slots         InstructorSlot[]

  @@unique([instructorId, effectiveTo])
}

model InstructorSlot {
  scheduleId Int
  weekday    Int
  startTime  DateTime           @db.Time
  schedule   InstructorSchedule @relation(fields: [scheduleId], references: [id])

  @@id([scheduleId, weekday, startTime])
}

model InstructorAbsence {
  instructorId Int
  absentAt     DateTime
  instructor   Instructor @relation(fields: [instructorId], references: [id])

  @@id([instructorId, absentAt])
}

model SystemStatus {
  id        Int      @id @default(autoincrement())
  status    String   @default("Running")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
