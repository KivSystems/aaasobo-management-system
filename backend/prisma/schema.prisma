generator client {
  provider   = "prisma-client-js"
  output     = "../generated/prisma"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

model Instructor {
  id                  Int                  @id @default(autoincrement())
  name                String
  email               String               @unique
  password            String
  classURL            String               @unique
  icon                String               @unique
  nickname            String               @unique
  meetingId           String               @unique
  passcode            String               @unique
  createdAt           DateTime             @default(now())
  birthdate           DateTime
  favoriteFood        String
  hobby               String
  lifeHistory         String
  messageForChildren  String
  skill               String
  workingTime         String
  terminationAt       DateTime?
  updatedAt           DateTime             @default(now()) @updatedAt
  isNative            Boolean
  classes             Class[]
  instructorAbsences  InstructorAbsence[]
  instructorSchedules InstructorSchedule[]
  recurringClasses    RecurringClass[]

  @@index([terminationAt])
}

model Customer {
  id             Int            @id @default(autoincrement())
  name           String
  email          String         @unique
  password       String
  prefecture     String
  emailVerified  DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  hasSeenWelcome Boolean        @default(false)
  terminationAt  DateTime?
  children       Child[]
  classes        Class[]
  subscription   Subscription[]

  @@index([terminationAt])
}

model Class {
  id               Int               @id @default(autoincrement())
  instructorId     Int?
  customerId       Int
  recurringClassId Int?
  dateTime         DateTime?
  status           Status
  subscriptionId   Int?
  rebookableUntil  DateTime?
  classCode        String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  isFreeTrial      Boolean           @default(false)
  customer         Customer          @relation(fields: [customerId], references: [id])
  instructor       Instructor?       @relation(fields: [instructorId], references: [id])
  recurringClass   RecurringClass?   @relation(fields: [recurringClassId], references: [id])
  subscription     Subscription?     @relation(fields: [subscriptionId], references: [id])
  classAttendance  ClassAttendance[]

  @@index([status])
  @@index([dateTime])
  @@index([customerId])
  @@index([instructorId])
  @@index([status, dateTime])
  @@index([customerId, dateTime])
  @@index([instructorId, dateTime])
  @@index([customerId, status, dateTime])
  @@index([instructorId, status, dateTime])
  @@index([recurringClassId, dateTime])
  @@index([rebookableUntil])
}

model ClassAttendance {
  classId    Int
  childrenId Int
  children   Child @relation(fields: [childrenId], references: [id])
  class      Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@id([classId, childrenId])
  @@index([classId])
  @@index([childrenId])
}

model Plan {
  id               Int            @id @default(autoincrement())
  name             String
  description      String
  weeklyClassTimes Int
  createdAt        DateTime       @default(now())
  terminationAt    DateTime?
  updatedAt        DateTime       @default(now()) @updatedAt
  isNative         Boolean
  subscription     Subscription[]
}

model Subscription {
  id             Int              @id @default(autoincrement())
  planId         Int
  customerId     Int
  startAt        DateTime
  endAt          DateTime?
  class          Class[]
  recurringClass RecurringClass[]
  customer       Customer         @relation(fields: [customerId], references: [id])
  plan           Plan             @relation(fields: [planId], references: [id])

  @@index([customerId])
}

model RecurringClass {
  id                       Int                        @id @default(autoincrement())
  instructorId             Int?
  subscriptionId           Int?
  startAt                  DateTime?
  endAt                    DateTime?
  classes                  Class[]
  instructor               Instructor?                @relation(fields: [instructorId], references: [id])
  subscription             Subscription?              @relation(fields: [subscriptionId], references: [id])
  recurringClassAttendance RecurringClassAttendance[]

  @@index([instructorId, endAt])
  @@index([subscriptionId, endAt])
  @@index([endAt])
}

model RecurringClassAttendance {
  recurringClassId Int
  childrenId       Int
  children         Child          @relation(fields: [childrenId], references: [id])
  recurringClass   RecurringClass @relation(fields: [recurringClassId], references: [id])

  @@id([recurringClassId, childrenId])
  @@index([recurringClassId])
  @@index([childrenId])
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model Schedule {
  id      Int      @id @default(autoincrement())
  date    DateTime @unique
  eventId Int
  event   Event    @relation(fields: [eventId], references: [id])
}

model Event {
  id       Int        @id @default(autoincrement())
  name     String     @unique
  color    String     @unique
  Schedule Schedule[]
}

model InstructorSchedule {
  id            Int              @id @default(autoincrement())
  instructorId  Int
  effectiveFrom DateTime         @db.Date
  effectiveTo   DateTime?        @db.Date
  timezone      String
  instructor    Instructor       @relation(fields: [instructorId], references: [id])
  slots         InstructorSlot[]

  @@unique([instructorId, effectiveTo])
  @@index([instructorId, effectiveTo])
  @@index([instructorId, effectiveFrom])
  @@index([instructorId, timezone, effectiveFrom])
}

model InstructorSlot {
  scheduleId Int
  weekday    Int
  startTime  DateTime           @db.Time(6)
  schedule   InstructorSchedule @relation(fields: [scheduleId], references: [id])

  @@id([scheduleId, weekday, startTime])
}

model InstructorAbsence {
  instructorId Int
  absentAt     DateTime
  instructor   Instructor @relation(fields: [instructorId], references: [id])

  @@id([instructorId, absentAt])
  @@index([instructorId])
  @@index([absentAt])
}

model SystemStatus {
  id        Int      @id @default(autoincrement())
  status    String   @default("Running")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Admin {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

model Child {
  id                       Int                        @id @default(autoincrement())
  customerId               Int
  name                     String
  birthdate                DateTime?
  personalInfo             String?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @default(now())
  Customer                 Customer                   @relation(fields: [customerId], references: [id])
  classAttendance          ClassAttendance[]
  recurringClassAttendance RecurringClassAttendance[]

  @@index([customerId])
}

enum Status {
  booked
  completed
  canceledByCustomer
  canceledByInstructor
  pending
  rebooked
  declined
}
